/* ====================================================
 *                  æ§åˆ¶å°æ¬¢è¿ä¿¡æ¯
 * ==================================================== */
console.log("%c ğŸŒˆ Theme By Ether | ä½œè€…ï¼šæ—ç¿Š | å®˜ç½‘ï¼šhttps://amrx.me ğŸŒˆ", 
  "color:#2D2D2D;background:#F9F9F9;padding: 4px;border: 2px solid #000;border-radius: 0;font-family: 'Courier New';text-shadow: 1px 1px 0 #FFF;box-shadow: 3px 3px 0 #D3D3D3;margin:30px 0;");

/* ====================================================
 *                  è¯„è®ºä»£ç å—æ¨¡æ€æ¡†åŠŸèƒ½
 * ==================================================== */

/**
 * åˆå§‹åŒ–å•ä¸ªä»£ç å—çš„æ¨¡æ€æ¡†åŠŸèƒ½
 * @param {HTMLElement} preElement - è¦åˆå§‹åŒ–çš„preå…ƒç´ 
 */
function initSingleCodeModal(preElement) {
    const $pre = $(preElement);
    
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if ($pre.data('has-modal')) return;
    $pre.data('has-modal', true);
    
    // è·å–ä»£ç å†…å®¹
    const codeContent = $pre.html();
    // ç”Ÿæˆå”¯ä¸€æ¨¡æ€æ¡†ID
    const modalId = 'modal-' + Math.random().toString(36).substr(2, 9);
    
    // æ·»åŠ æŸ¥çœ‹ä»£ç æŒ‰é’®
    $pre.before(`
        <button class="code-modal-btn" data-modal="${modalId}">
            æŸ¥çœ‹å®Œæ•´ä»£ç 
        </button>
    `);

    // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
    $('body').append(`
        <div id="${modalId}" class="code-modal">
            <div class="modal-content">
                <div class="modal-toolbar">
                    <span class="close-modal">&times;</span>
                    <button class="copy-btn">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                </div>
                <div class="modal-code">
                    <pre>${codeContent}</pre>
                </div>
            </div>
        </div>
    `);
}

/**
 * åˆå§‹åŒ–é¡µé¢ä¸­æ‰€æœ‰ä»£ç å—çš„æ¨¡æ€æ¡†åŠŸèƒ½
 */
function initCodeModal() {
    $('.comments-content pre').each(function() {
        initSingleCodeModal(this);
    });
}

/**
 * åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
 */
function initPage() {
    // åˆå§‹åŒ–ä»£ç æ¨¡æ€æ¡†
    initCodeModal();
    
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€å†…å®¹
    $(document)
        // ç§»é™¤æ—§äº‹ä»¶ç»‘å®šé˜²æ­¢é‡å¤
        .off('click', '.code-modal-btn')
        // ç‚¹å‡»æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
        .on('click', '.code-modal-btn', function() {
            $('#' + $(this).data('modal')).fadeIn(200);
        })
        // ç§»é™¤æ—§äº‹ä»¶ç»‘å®šé˜²æ­¢é‡å¤
        .off('click', '.close-modal')
        // ç‚¹å‡»å…³é—­æŒ‰é’®å…³é—­æ¨¡æ€æ¡†
        .on('click', '.close-modal', function(e) {
            $(this).closest('.code-modal').fadeOut(200);
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        })
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
        .on('click', '.code-modal', function(e) {
            if ($(e.target).hasClass('code-modal')) {
                $(this).fadeOut(200);
            }
        })
        // ç§»é™¤æ—§äº‹ä»¶ç»‘å®šé˜²æ­¢é‡å¤
        .off('click', '.copy-btn')
        // ç‚¹å‡»å¤åˆ¶æŒ‰é’®å¤„ç†å¤åˆ¶åŠŸèƒ½
        .on('click', '.copy-btn', handleCopy);
}

/**
 * å¤„ç†ä»£ç å¤åˆ¶åŠŸèƒ½
 */
async function handleCopy() {
    const $btn = $(this);
    // è·å–è¦å¤åˆ¶çš„ä»£ç å†…å®¹
    const code = $btn.closest('.modal-content').find('pre').text();
    
    try {
        // å°è¯•ä½¿ç”¨ç°ä»£å‰ªè´´æ¿API
        await navigator.clipboard.writeText(code);
        $btn.html('âœ… å·²å¤åˆ¶');
        setTimeout(() => $btn.html('ğŸ“‹ å¤åˆ¶ä»£ç '), 2000);
    } catch (err) {
        // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
        const textarea = document.createElement('textarea');
        textarea.value = code;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        $btn.html('âœ“ å·²å¤åˆ¶');
        setTimeout(() => $btn.html('ğŸ“‹ å¤åˆ¶ä»£ç '), 1500);
    }
}

/* ====================================================
 *                  è¿”å›é¡¶éƒ¨åŠŸèƒ½
 * ==================================================== */
(function() {
    // è·å–è¿”å›é¡¶éƒ¨æŒ‰é’®å…ƒç´ 
    const backToTopButton = document.querySelector('.back-to-top');
    // è®¾ç½®æ˜¾ç¤ºæŒ‰é’®çš„æ»šåŠ¨é˜ˆå€¼ï¼ˆ300pxï¼‰
    const scrollThreshold = 300;

    /**
     * æ ¹æ®æ»šåŠ¨ä½ç½®æ˜¾ç¤º/éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
     */
    function toggleButton() {
        if (window.scrollY > scrollThreshold) {
            backToTopButton.classList.add('show');
        } else {
            backToTopButton.classList.remove('show');
        }
    }

    /**
     * å¹³æ»‘æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
     */
    function scrollToTop() {
        const startPosition = window.scrollY;
        const duration = 500; // åŠ¨ç”»æŒç»­æ—¶é—´(æ¯«ç§’)
        const startTime = performance.now();

        /**
         * æ»šåŠ¨åŠ¨ç”»æ­¥éª¤
         * @param {number} timestamp æ—¶é—´æˆ³
         */
        function scrollStep(timestamp) {
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1);
            // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°ä½¿æ»šåŠ¨æ›´å¹³æ»‘
            const easeProgress = 1 - Math.pow(1 - progress, 3);

            window.scrollTo(0, startPosition * (1 - easeProgress));

            if (progress < 1) {
                requestAnimationFrame(scrollStep);
            }
        }

        requestAnimationFrame(scrollStep);
    }

    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', toggleButton);
    // ç›‘å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    backToTopButton.addEventListener('click', scrollToTop);

    // åˆå§‹åŒ–æ—¶æ£€æŸ¥æŒ‰é’®çŠ¶æ€
    toggleButton();
})();

/* ====================================================
 *                  èµåŠ©å¼¹çª—åŠŸèƒ½
 * ==================================================== */
function initRewardModal() {
    // ç‚¹å‡»è§¦å‘æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('.post-reward_btn').on('click', function(e) {
        e.preventDefault();
        $('.reward-modal').addClass('is-open');
    });

    // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–é®ç½©å±‚éšè—æ¨¡æ€æ¡†
    $('.close-btn, .modal-overlay').on('click', function() {
        $('.reward-modal').removeClass('is-open');
    });

    // é˜»æ­¢æ¨¡æ€æ¡†å†…å®¹ç‚¹å‡»äº‹ä»¶å†’æ³¡
    $('.modal-body').on('click', function(e) {
        e.stopPropagation();
    });
}

/* ====================================================
 *                  é€šçŸ¥å¼¹çª—åŠŸèƒ½
 * ==================================================== */
function initNoticeModal() {
    // ç‚¹å‡»è§¦å‘æŒ‰é’®æ˜¾ç¤ºæ¨¡æ€æ¡†
    $('.notice-trigger-btn').on('click', function(e) {
        e.preventDefault();
        $('.notice-modal').addClass('is-open');
    });

    // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–é®ç½©å±‚éšè—æ¨¡æ€æ¡†
    $('.close-btn, .modal-overlay').on('click', function() {
        $('.notice-modal').removeClass('is-open');
    });

    // é˜»æ­¢æ¨¡æ€æ¡†å†…å®¹ç‚¹å‡»äº‹ä»¶å†’æ³¡
    $('.modal-body').on('click', function(e) {
        e.stopPropagation();
    });
}

/* ====================================================
 *                  é¦–é¡µå¹»ç¯ç‰‡åŠŸèƒ½
 * ==================================================== */
function initCarousel() {
    // é”€æ¯æ—§å®ä¾‹é¿å…é‡å¤åˆå§‹åŒ–
    if ($('.single-list').hasClass('slick-initialized')) {
        $('.single-list').slick('unslick');
    }
    
    // åˆå§‹åŒ–æ–°è½®æ’­å®ä¾‹
    $('.single-list').slick({
        autoplay: true,          // è‡ªåŠ¨æ’­æ”¾
        autoplaySpeed: 3000,     // è‡ªåŠ¨æ’­æ”¾é€Ÿåº¦(ms)
        dots: true,              // æ˜¾ç¤ºæŒ‡ç¤ºç‚¹
        arrows: false,           // éšè—ç®­å¤´
        infinite: true,          // æ— é™å¾ªç¯
        speed: 500,              // åˆ‡æ¢é€Ÿåº¦(ms)
        slidesToShow: 1,         // æ¯æ¬¡æ˜¾ç¤º1å¼ 
        slidesToScroll: 1,       // æ¯æ¬¡æ»šåŠ¨1å¼ 
        adaptiveHeight: true,    // è‡ªé€‚åº”é«˜åº¦
        pauseOnHover: true,      // æ‚¬åœæš‚åœ
        pauseOnFocus: true,      // è·å–ç„¦ç‚¹æ—¶æš‚åœ
        responsive: [            // å“åº”å¼é…ç½®
            {
                breakpoint: 768,  // 768pxä»¥ä¸‹é…ç½®
                settings: {
                    arrows: false,
                    dots: true
                }
            },
            {
                breakpoint: 480,  // 480pxä»¥ä¸‹é…ç½®
                settings: {
                    arrows: false,
                    dots: true,
                    adaptiveHeight: false
                }
            }
        ]
    });
}

/* ====================================================
 *                  é¦–é¡µæ–‡ç« å±•å¼€æ”¶èµ·åŠŸèƒ½
 * ==================================================== */
function initArticleFold() {
    // æ¸…ç†æ—§ç»‘å®š (é˜²æ­¢é‡å¤åˆå§‹åŒ–)
    $('.blog_content').removeData('initialized');

    // éå†æ‰€æœ‰æ–‡ç« å®¹å™¨
    $('.post_conter').each(function() {
        const $post = $(this);
        const $content = $post.find('.blog_content');
        
        // è·³è¿‡å·²å¤„ç†å†…å®¹
        if ($content.data('initialized')) return;

        // åŠ¨æ€è®¡ç®—å‚æ•°
        const lineHeight = parseInt($content.css('line-height')) || 24;
        const maxLines = 8;
        const maxHeight = lineHeight * maxLines;

        // åˆ¤æ–­æ˜¯å¦éœ€è¦æŠ˜å 
        if ($content.height() > maxHeight) {
            $content
                .css({
                    'max-height': maxHeight + 'px',
                    'overflow': 'hidden',
                    'position': 'relative',
                    'transition': 'max-height 0.3s ease-out'
                })
                .append('<div class="fade-overlay"></div>')
                .after(`
                    <div class="content-controls">
                        <a class="show-more" href="#">å±•å¼€ â†“</a>
                        <a class="show-less" href="#" style="display:none">æ”¶èµ· â†‘</a>
                    </div>
                `)
                .data('initialized', true);
        }
    });
}

// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€å†…å®¹çš„å±•å¼€/æ”¶èµ·
$(document)
    .on('click', '.show-more', function(e) {
        e.preventDefault();
        const $control = $(this).closest('.content-controls');
        const $content = $control.prev('.blog_content');
        
        $content
            .css('max-height', $content[0].scrollHeight + 'px')
            .find('.fade-overlay').fadeOut(200);
        
        $control.find('.show-more').hide();
        $control.find('.show-less').show();
    })
    .on('click', '.show-less', function(e) {
        e.preventDefault();
        const $control = $(this).closest('.content-controls');
        const $content = $control.prev('.blog_content');
        const lineHeight = parseInt($content.css('line-height')) || 24;
        
        $content
            .css('max-height', lineHeight * 8 + 'px')
            .find('.fade-overlay').fadeIn(200);
        
        $control.find('.show-less').hide();
        $control.find('.show-more').show();
    });

/**
 * åŠ¨æ€åŠ è½½å†…å®¹åé‡æ–°åˆå§‹åŒ–
 */
function onNewContentLoaded() {
    initArticleFold();
    $('.fade-overlay').fadeIn(0); // ç¡®ä¿æ–°å†…å®¹çš„é®ç½©å¯è§
}

/* ====================================================
 *                  æ— é™æ»šåŠ¨åŠ è½½æ›´å¤šæ–‡ç« 
 * ==================================================== */
function setupScrollLoad() {
    var isLoading = false; // åŠ è½½çŠ¶æ€æ ‡è®°

    // ç›‘å¬æ»šåŠ¨å’Œè§¦æ‘¸ç§»åŠ¨äº‹ä»¶
    $(window).on('scroll touchmove', function() {
        // è®¡ç®—å½“å‰æ»šåŠ¨ä½ç½® + çª—å£é«˜åº¦
        var scrollBottom = Math.floor($(window).scrollTop()) + window.innerHeight;
        var documentHeight = $(document).height();

        // æ£€æŸ¥æ˜¯å¦æ¥è¿‘åº•éƒ¨ä¸”æ²¡æœ‰æ­£åœ¨åŠ è½½
        if (!isLoading && Math.abs(scrollBottom - documentHeight) < 50 && $('.archive_next .next').length > 0) {
            isLoading = true; // æ ‡è®°ä¸ºæ­£åœ¨åŠ è½½
            setTimeout(function() {
                $('.archive_next .next').click(); // è§¦å‘åŠ è½½æ›´å¤š
            }, 300); // å»¶è¿Ÿ300msè§¦å‘
        }
    });

    // ç‚¹å‡»åŠ è½½æ›´å¤šæŒ‰é’®çš„å¤„ç†
    $('.main-content').on('click', '.archive_next .next', function() {
        var $this = $(this);
        $this.addClass('loading').text("loading"); // æ·»åŠ åŠ è½½çŠ¶æ€
        var href = $this.attr('href'); // è·å–ä¸‹ä¸€é¡µé“¾æ¥

        if (href !== undefined) {
            $.ajax({
                url: href,
                type: 'get',
                error: function(request) {
                    console.error('åŠ è½½å¤±è´¥:', request);
                    $this.removeClass('loading').text("åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•");
                    isLoading = false;
                },
                success: function(data) {
                    $this.removeClass('loading').text("more"); // ç§»é™¤åŠ è½½çŠ¶æ€

                    // æ’å…¥æ–°å†…å®¹
                    var $res = $(data).find('.article-item');
                    $('.index_list').append($res.fadeIn(500));

                    // æ›´æ–°ä¸‹ä¸€é¡µé“¾æ¥
                    var newHref = $(data).find('.archive_next .next').attr('href');
                    if (newHref !== undefined) {
                        $('.archive_next .next').attr('href', newHref);
                    } else {
                        $('.archive_next .next').remove(); // æ²¡æœ‰æ›´å¤šå†…å®¹æ—¶ç§»é™¤æŒ‰é’®
                        $('.archive_next').append('<span class="over">å·²å…¨éƒ¨åŠ è½½</span>');
                    }

                    isLoading = false; // é‡ç½®åŠ è½½çŠ¶æ€
                    // é‡è½½pjax
                    pjax.refresh();
                
                    // åˆå§‹åŒ–æ–°å†…å®¹
                    onNewContentLoaded();
                }
            });
        }
        return false; // é˜»æ­¢é»˜è®¤è¡Œä¸º
    });
}

/* ====================================================
 *                  ç§»åŠ¨ç«¯å¯¼èˆªèœå•
 * ==================================================== */
function initMenu() {
    // èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.life_menu').click(function(e) {
        if ($('.navbar-nav').css('left') != '0px') {
            $('.navbar-nav').css('left', '0');
            $('.menu_off').css('left', '0');
        } else {
            $('.menu_off').click();
        }
    });
    
    // å…³é—­èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.menu_off').click(function(e) {
        $('.navbar-nav').css('left', '-18rem');
        $('.menu_off').css('left', '-100vw');
    });
}

/* ====================================================
 *                  è¯„è®ºåŠ è½½æ›´å¤šåŠŸèƒ½
 * ==================================================== */
const loadedPages = new Set(); // å­˜å‚¨å·²åŠ è½½çš„é¡µé¢URLï¼Œé˜²æ­¢é‡å¤åŠ è½½

function comments_next() {
    const loadMoreButton = document.getElementById('load-more-comments');
    if (!loadMoreButton) return;

    loadMoreButton.addEventListener('click', async () => {
        const nextPageUrl = document.querySelector('.page-navigator .next a')?.href;
        if (!nextPageUrl) {
            updateLoadMoreButton();
            return;
        }

        // é˜²æ­¢é‡å¤åŠ è½½ç›¸åŒé¡µé¢
        if (loadedPages.has(nextPageUrl)) return;

        try {
            loadMoreButton.disabled = true;
            loadMoreButton.textContent = 'åŠ è½½ä¸­...';

            const response = await fetch(nextPageUrl);
            if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);

            const html = await response.text();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // æ’å…¥æ–°è¯„è®º
            const commentList = document.querySelector('.comment-list');
            const newComments = tempDiv.querySelector('.comment-list');
            if (newComments) {
                commentList.insertAdjacentHTML('beforeend', newComments.innerHTML);
                
                // åˆå§‹åŒ–æ–°åŠ è½½çš„ä»£ç å—
                $(commentList).find('pre').each(function() {
                    initSingleCodeModal(this);
                });
            }

            // æ›´æ–°åˆ†é¡µå¯¼èˆª
            const newNavigator = tempDiv.querySelector('.page-navigator');
            if (newNavigator) {
                document.querySelector('.page-navigator').innerHTML = newNavigator.innerHTML;
            }

            updateLoadMoreButton(tempDiv);
            scrollToLatestComment();
            loadedPages.add(nextPageUrl);
            // é‡æ–°ç»‘å®šè¯„è®ºæäº¤äº‹ä»¶
            initCommentSubmit();
        } catch (error) {
            console.error('åŠ è½½å¤±è´¥:', error);
            Qmsg.error('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = 'åŠ è½½æ›´å¤š';
        }
    });
}

/**
 * æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®çš„çŠ¶æ€
 * @param {HTMLElement} tempDiv - ä¸´æ—¶å®¹å™¨ï¼ŒåŒ…å«æ–°åŠ è½½çš„HTML
 */
function updateLoadMoreButton(tempDiv) {
    const loadMoreButton = document.getElementById('load-more-comments');
    if (!loadMoreButton) return;

    // å¦‚æœæ²¡æœ‰ä¸‹ä¸€é¡µé“¾æ¥ï¼Œéšè—æŒ‰é’®
    const hasNextPage = tempDiv ? tempDiv.querySelector('.page-navigator .next a') : document.querySelector('.page-navigator .next a');
    if (!hasNextPage) {
        loadMoreButton.style.display = 'none';
    }
}

/**
 * æ»šåŠ¨åˆ°æœ€æ–°åŠ è½½çš„è¯„è®º
 */
function scrollToLatestComment() {
    const comments = document.querySelectorAll('.comment-list');
    if (comments.length > 0) {
        // æ»šåŠ¨åˆ°æœ€æ–°è¯„è®ºçš„ä½ç½®
        comments[comments.length - 1].scrollIntoView({ behavior: 'smooth' });

        // è‡ªåŠ¨ä¸‹æ»‘155px
        window.scrollBy({
            top: 155,
            behavior: 'smooth'
        });
    }
}

/* ====================================================
 *                  AJAXè¯„è®ºåŠŸèƒ½
 * ==================================================== */
function initCommentSubmit() {
    $('.submit').on('click', function (e) {
        e.preventDefault();
        var action = $('#comment-form').attr('action') + '?time=' + new Date();
        var mail = $("#mail").val();
        var author = $("#author").val();
        var url = $("#url").val();
        var parent = $('#comment-parent') ? $('#comment-parent').val() : null;
        let text = $("#textarea").val();

        // è¡¨å•éªŒè¯
        if (!/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/.test(mail)) 
            return Qmsg.warning('è¯·è¾“å…¥æ­£ç¡®çš„é‚®ç®±ï¼');
        if (author.trim() === '') 
            return Qmsg.warning('è¯·è¾“å…¥æ˜µç§°ï¼');
        if (text.trim() === '') 
            return Qmsg.warning('è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼');

        Qmsg.loading('è¯„è®ºä¸­...');

        $.ajax({
            url: action,
            type: 'POST',
            data: { author, mail, text, parent, url },
            dataType: 'text',
            success(data) {
                Qmsg.closeAll();
                Qmsg.success('è¯„è®ºæˆåŠŸï¼');

                // æ›´æ–°è¯„è®ºæ•°é‡
                var commentText = $('.comments-title b').text().replace(/[^0-9]/g, '');
                var num = commentText ? parseInt(commentText) : 0;
                $('.comments-title b').text(num + 1 + ' æ¡è¯„è®º');

                // æ¸…ç©ºè¯„è®ºæ¡†
                $('#textarea').val('');

                // è·å–æ–°è¯„è®ºID
                var newCommentId = $(".comment-body", data).map(function () {
                    return this.id.match(/\d+/);
                }).get().sort(function (a, b) { return a - b }).pop();

                // æ’å…¥æ–°è¯„è®º
                if (newCommentId) {
                    var newComment = $("#li-comment-" + newCommentId, data);
                    insertComment(newComment, parent);
                }
            },
            error(data) {
                var word = $.trim(data.responseText.match(/<div\sclass="container">([\s\S]*?)<\/div>/)[1]);
                var msg = word ? word : 'è¯„è®ºå¤±è´¥ï¼';
                Qmsg.closeAll();
                Qmsg.error(msg);

                // å°è¯•ä»é”™è¯¯å“åº”ä¸­æå–è¯„è®ºä¿¡æ¯
                var newCommentId = $(".comment-body", data.responseText).map(function () {
                    return this.id.match(/\d+/);
                }).get().sort(function (a, b) { return a - b }).pop();

                if (newCommentId) {
                    var newComment = $("#li-comment-" + newCommentId, data.responseText);
                    insertComment(newComment, parent);
                }
            }
        });

        /**
         * æ’å…¥æ–°è¯„è®ºåˆ°DOM
         * @param {jQuery} newComment - æ–°è¯„è®ºå…ƒç´ 
         * @param {string|null} parent - çˆ¶è¯„è®ºID
         */
        function insertComment(newComment, parent) {
            if (!parent) {
                // å¤„ç†çˆ¶çº§è¯„è®º
                var noCommentsElement = $('.comments-main .no-comments');
                if (noCommentsElement.length > 0) {
                    // æ›¿æ¢"æš‚æ— è¯„è®º"æç¤º
                    noCommentsElement.replaceWith(newComment);
                    if (!$('.comments-main .comment-list').length) {
                        $('.comments-main').append('<ol class="comment-list"></ol>');
                    }
                    $('.comments-main .comment-list').first().prepend(newComment);
                } else {
                    if (!$('.comments-main .comment-list').length) {
                        $('.comments-main').append('<ol class="comment-list"></ol>');
                    }
                    $('.comments-main .comment-list').first().prepend(newComment);
                }
            } else {
                // å¤„ç†å­çº§è¯„è®º
                let parentComment = $('#li-comment-' + parent);
                let childrenList = parentComment.find('.comment-children .comment-list');

                if (!childrenList.length) {
                    // åˆ›å»ºå­è¯„è®ºåˆ—è¡¨
                    parentComment.append('<div class="comment-children"><ol class="comment-list"></ol></div>');
                    childrenList = parentComment.find('.comment-children .comment-list');
                }
                childrenList.first().prepend(newComment);
                TypechoComment.cancelReply();
            }
        }
    });
}

/* ====================================================
 *                  æ–‡ç« ç‚¹èµåŠŸèƒ½
 * ==================================================== */
function initLikeFunction() {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ç‚¹èµ
    $(document).on('click', '.post_like', function (e) {
        e.preventDefault();
        var $this = $(this);
        var cid = $this.data('id');

        // æ£€æŸ¥24å°æ—¶å†…æ˜¯å¦å·²ç‚¹èµ
        var lastLikeTime = localStorage.getItem('like_' + cid);
        if (lastLikeTime) {
            var now = new Date().getTime();
            var twentyFourHours = 24 * 60 * 60 * 1000;
            if (now - parseInt(lastLikeTime) < twentyFourHours) {
                Qmsg.closeAll();
                Qmsg.error('æ˜å¤©å†æ¥å§ï¼');
                return false;
            }
        }

        if ($this.hasClass('loading')) return false;

        $this.addClass('loading');

        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: {
                action: 'specs_zan',
                cid: cid
            },
            success: function (data) {
                $this.find('.count').text(data);
                $this.addClass('done');
                // è®°å½•ç‚¹èµæ—¶é—´
                localStorage.setItem('like_' + cid, new Date().getTime());
                Qmsg.closeAll();
                Qmsg.success('ç‚¹èµæˆåŠŸï¼');
                setTimeout(function () {
                    $this.removeClass('done');
                }, 1000);
            },
            complete: function () {
                $this.removeClass('loading');
            }
        });

        return false;
    });
}

/* ====================================================
 *                  æ–‡æ¡£åŠ è½½åˆå§‹åŒ–
 * ==================================================== */
document.addEventListener("DOMContentLoaded", () => {
    initRewardModal();    // åˆå§‹åŒ–èµåŠ©å¼¹çª—
    initNoticeModal();    // åˆå§‹åŒ–é€šçŸ¥å¼¹çª—
    initCarousel();       // åˆå§‹åŒ–è½®æ’­å›¾
    setupScrollLoad();    // è®¾ç½®æ— é™æ»šåŠ¨
    initMenu();           // åˆå§‹åŒ–ç§»åŠ¨ç«¯èœå•
    comments_next();      // åˆå§‹åŒ–è¯„è®ºåŠ è½½æ›´å¤š
    initPage();           // åˆå§‹åŒ–è¯„è®ºä»£ç ç¾åŒ–
    initCommentSubmit();  // åˆå§‹åŒ–AJAXè¯„è®º
    initLikeFunction();   // åˆå§‹åŒ–ç‚¹èµåŠŸèƒ½
});